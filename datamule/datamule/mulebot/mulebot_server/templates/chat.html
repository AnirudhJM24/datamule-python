<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Frontend</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        #chat-container {
            height: 400px;
            overflow-y: auto;
        }

        #table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: "\25BC";
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Chatbot</h1>
        <div class="row">
            <div class="col-md-6">
                <div id="chat-container" class="border p-3 mb-3"></div>
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <div id="table-container" class="border p-3">
                    <div class="mb-3 select-wrapper">
                        <input type="text" id="table-select" class="form-control" placeholder="Select a table...">
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                    </div>
                    <div class="mb-3">
                        <button id="download-csv" class="btn btn-secondary me-2">Download Selected Table (CSV)</button>
                        <button id="download-all-zip" class="btn btn-secondary">Download All Tables (ZIP)</button>
                    </div>
                    <div id="metadata-content"></div>
                    <div id="table-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const tableContainer = document.getElementById('table-container');
        const tableSelect = document.getElementById('table-select');
        const autocompleteList = document.getElementById('autocomplete-list');
        const metadataContent = document.getElementById('metadata-content');
        const tableContent = document.getElementById('table-content');
        const downloadCsvBtn = document.getElementById('download-csv');
        const downloadAllZipBtn = document.getElementById('download-all-zip');

        let tables = [];
        let selectedTable = null;

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (message) {
                appendMessage('You', message);
                userInput.value = '';
                const response = await sendMessage(message);
                handleResponse(response);
            }
        });

        function appendMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage(message) {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message }),
            });
            return response.json();
        }

        function handleResponse(response) {
            if (response.response.type === 'text') {
                appendMessage('Bot', response.response.content);
            } else if (response.response.type === 'artifact' && response.response.artifact_type === 'table') {
                appendMessage('Bot', 'I have prepared a table for you. Please check the table view.');
                renderTables(response.response.content);
            }
        }

        function renderTables(tableData) {
            tables = Array.isArray(tableData) ? tableData : [tableData];

            tableSelect.addEventListener('input', function (e) {
                const val = this.value.toLowerCase();
                createAutocompleteList(tables.filter(table =>
                    table.fact.toLowerCase().includes(val)
                ));
            });

            tableSelect.addEventListener('focus', function () {
                createAutocompleteList(tables);
            });

            if (tables.length > 0) {
                selectedTable = tables[0];
                tableSelect.value = selectedTable.fact;
                renderSelectedTable(selectedTable);
                createAutocompleteList(tables);
            }
        }

        function createAutocompleteList(filteredTables) {
            autocompleteList.innerHTML = '';
            filteredTables.forEach(table => {
                const div = document.createElement("div");
                div.innerHTML = table.fact;
                div.addEventListener("click", function (e) {
                    tableSelect.value = this.innerHTML;
                    selectedTable = table;
                    renderSelectedTable(table);
                    closeAutocompleteList();
                });
                autocompleteList.appendChild(div);
            });
        }

        function closeAutocompleteList() {
            autocompleteList.style.display = 'none';
        }

        function renderSelectedTable(selectedTable) {
            renderMetadata(selectedTable);
            renderTableContent(selectedTable);
        }

        function renderMetadata(tableData) {
            const metadataHtml = `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Metadata</h5>
                        <p><strong>CIK:</strong> ${tableData.cik}</p>
                        <p><strong>Category:</strong> ${tableData.category}</p>
                        <p><strong>Fact:</strong> ${tableData.fact}</p>
                        <p><strong>Label:</strong> ${tableData.label}</p>
                        <p><strong>Description:</strong> ${tableData.description}</p>
                        <p><strong>Unit:</strong> ${tableData.unit}</p>
                    </div>
                </div>
            `;
            metadataContent.innerHTML = metadataHtml;
        }

        function renderTableContent(tableData) {
            if (tableData.table && tableData.table.length > 0) {
                let html = '<table class="table table-striped mt-3">';
                html += '<thead><tr>';
                Object.keys(tableData.table[0]).forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead><tbody>';
                tableData.table.forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(cell => {
                        html += `<td>${cell}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                tableContent.innerHTML = html;
            } else {
                tableContent.innerHTML = '<p>No table data available.</p>';
            }
        }

        // Show autocomplete list when clicking on the input
        tableSelect.addEventListener("click", function (e) {
            createAutocompleteList(tables);
            autocompleteList.style.display = 'block';
        });

        // Close the autocomplete list when clicking outside
        document.addEventListener("click", function (e) {
            if (e.target !== tableSelect) {
                closeAutocompleteList();
            }
        });

        // Download CSV function
        function downloadCSV(table) {
            let csv = '';
            const headers = Object.keys(table.table[0]);
            csv += headers.join(',') + '\n';
            table.table.forEach(row => {
                csv += Object.values(row).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `${table.fact}.csv`);
        }

        // Download selected table as CSV
        downloadCsvBtn.addEventListener('click', () => {
            if (selectedTable) {
                downloadCSV(selectedTable);
            } else {
                alert('Please select a table first.');
            }
        });

        // Download all tables as ZIP
        downloadAllZipBtn.addEventListener('click', async () => {
            const zip = new JSZip();
            tables.forEach(table => {
                let csv = '';
                const headers = Object.keys(table.table[0]);
                csv += headers.join(',') + '\n';
                table.table.forEach(row => {
                    csv += Object.values(row).join(',') + '\n';
                });
                zip.file(`${table.fact}.csv`, csv);
            });
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, "all_tables.zip");
        });
    </script>
</body>

</html>