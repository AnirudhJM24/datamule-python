<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Table for Chatbot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 100%;
        }

        h1,
        h2 {
            margin: 0 0 10px;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        th,
        td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .search-select-container {
            margin-bottom: 10px;
            position: relative;
        }

        #searchInput {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #tableList {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            background-color: white;
            z-index: 1;
        }

        #tableList div {
            padding: 8px;
            cursor: pointer;
        }

        #tableList div:hover {
            background-color: #f2f2f2;
        }

        #tableInfo p {
            margin: 5px 0;
        }

        .button-container {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Dynamic Table</h1>
        <div class="search-select-container">
            <input type="text" id="searchInput" placeholder="Search and select table...">
            <div id="tableList"></div>
        </div>
        <div class="button-container">
            <button id="copyTableBtn">Copy Table</button>
            <button id="downloadTableBtn">Download Table</button>
            <button id="downloadAllBtn">Download All Tables</button>
        </div>
        <div id="tableInfo"></div>
        <div id="tableContainer"></div>
    </div>

    <script>
        let allData = [];
        let currentTableIndex = 0;

        function displayTable(data, index) {
            const tableInfo = document.getElementById('tableInfo');
            const tableContainer = document.getElementById('tableContainer');
            currentTableIndex = index;

            tableInfo.innerHTML = `
                <h2>${data.label || 'Dynamic Table'}</h2>
                <p><strong>CIK:</strong> ${data.cik}</p>
                <p><strong>Category:</strong> ${data.category}</p>
                <p><strong>Fact:</strong> ${data.fact}</p>
                <p><strong>Description:</strong> ${data.description}</p>
            `;

            let tableHTML = '<table><thead><tr>';
            Object.keys(data.table[0]).forEach(key => {
                if (key !== 'val') {
                    tableHTML += `<th>${key === 'val' ? data.unit : key.charAt(0).toUpperCase() + key.slice(1)}</th>`;
                }
            });
            tableHTML += `<th>${data.unit.charAt(0).toUpperCase() + data.unit.slice(1)}</th></tr></thead><tbody>`;

            data.table.forEach(row => {
                tableHTML += '<tr>';
                Object.entries(row).forEach(([key, value]) => {
                    if (key !== 'val') {
                        tableHTML += `<td>${value}</td>`;
                    }
                });
                tableHTML += `<td>${row.val}</td></tr>`;
            });
            tableHTML += '</tbody></table>';

            tableContainer.innerHTML = tableHTML;
        }

        function initializeSearchSelect() {
            const searchInput = document.getElementById('searchInput');
            const tableList = document.getElementById('tableList');

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const filteredData = allData.filter(data =>
                    (data.label || '').toLowerCase().includes(searchTerm)
                );
                updateTableList(filteredData);
            });

            searchInput.addEventListener('focus', function () {
                tableList.style.display = 'block';
            });

            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !tableList.contains(e.target)) {
                    tableList.style.display = 'none';
                }
            });
        }

        function updateTableList(data) {
            const tableList = document.getElementById('tableList');
            tableList.innerHTML = '';
            data.forEach((item, index) => {
                const div = document.createElement('div');
                div.textContent = item.label || `Table ${index + 1}`;
                div.onclick = function () {
                    document.getElementById('searchInput').value = this.textContent;
                    displayTable(item, index);
                    tableList.style.display = 'none';
                };
                tableList.appendChild(div);
            });
            tableList.style.display = data.length > 0 ? 'block' : 'none';
            if (data.length === 0) {
                document.getElementById('tableInfo').innerHTML = '<p>No matching tables found.</p>';
                document.getElementById('tableContainer').innerHTML = '';
            }
        }

        function copyTableToClipboard() {
            const table = document.querySelector('table');
            if (!table) return;

            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            alert('Table copied to clipboard!');
        }

        function downloadTable() {
            const table = document.querySelector('table');
            if (!table) return;

            const data = allData[currentTableIndex];
            const csvContent = tableToCSV(data);
            downloadCSV(csvContent, `${data.label || 'table'}.csv`);
        }

        function downloadAllTables() {
            const zip = new JSZip();
            allData.forEach((data, index) => {
                const csvContent = tableToCSV(data);
                zip.file(`${data.label || `table_${index + 1}`}.csv`, csvContent);
            });
            zip.generateAsync({ type: "blob" }).then(function (content) {
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'all_tables.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        function tableToCSV(data) {
            let csv = [];
            let headers = Object.keys(data.table[0]).filter(key => key !== 'val');
            headers.push(data.unit);
            csv.push(headers.join(','));

            data.table.forEach(row => {
                let rowData = headers.map(header => {
                    if (header === data.unit) return row.val;
                    return row[header];
                });
                csv.push(rowData.join(','));
            });

            return csv.join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        document.getElementById('copyTableBtn').addEventListener('click', copyTableToClipboard);
        document.getElementById('downloadTableBtn').addEventListener('click', downloadTable);
        document.getElementById('downloadAllBtn').addEventListener('click', downloadAllTables);

        fetch('table.json')
            .then(response => response.json())
            .then(data => {
                allData = data;
                updateTableList(allData);
                initializeSearchSelect();
                if (allData.length > 0) {
                    displayTable(allData[0], 0);
                }
            })
            .catch(error => {
                console.error('Error loading the JSON file:', error);
                document.getElementById('tableInfo').innerHTML = '<p>Error loading data. Please check the console for details.</p>';
            });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</body>

</html>